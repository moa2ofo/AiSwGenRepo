# syntax=docker/dockerfile:1

# ------------------------------------------------------------------------
# Base Image (Frozen by Digest)
# ------------------------------------------------------------------------
FROM ubuntu@sha256:c35e29c9450151419d9448b0fd75374fec4fff364a27f176fb458d472dfc9e54

ENV DEBIAN_FRONTEND=noninteractive

# ------------------------------------------------------------------------
# Install Required Tools (all versions pinned)
# ------------------------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential=12.10ubuntu1 \
        cmake=3.28.3-1build7 \
        cppcheck=2.13.0-2ubuntu3 \
        python3=3.12.3-0ubuntu2.1 \
        python3-pip=24.0+dfsg-1ubuntu1.3 \
        python3-lxml=5.2.1-1 \
        python3-pygments=2.17.2+dfsg-1 \
        git=1:2.43.0-1ubuntu7.3 \
        ca-certificates=20240203 \

        indent \
    rm -rf /var/lib/apt/lists/*


WORKDIR /workspace

# ------------------------------------------------------------------------
# Configure MISRA Addon for Cppcheck
# ------------------------------------------------------------------------
RUN mkdir -p /opt/misra && \
    cat <<'EOF' > /opt/misra/misra.json
{
    "script": "misra.py",
    "args": [
        "--rule-texts=/workspace/misra/misra_c_2012_headlines.txt"
    ],
    "ctu": true
}
EOF

# ------------------------------------------------------------------------
# Script: run-misra-check.sh
# ------------------------------------------------------------------------
RUN cat <<'EOF' > /usr/local/bin/run-misra-check.sh
#!/usr/bin/env bash
set -euo pipefail

PROJ_DIR="${1:-$(pwd)}"

cd "${PROJ_DIR}"

# Locate compile_commands.json (generated by CMake)
if [ -f "build/compile_commands.json" ]; then
  CC_JSON="build/compile_commands.json"
elif [ -f "compile_commands.json" ]; then
  CC_JSON="compile_commands.json"
else
  echo "compile_commands.json not found in ${PROJ_DIR}." >&2
  echo "Run CMake with -DCMAKE_EXPORT_COMPILE_COMMANDS=ON." >&2
  exit 1
fi

# Determine number of parallel jobs for cppcheck:
CPPCHECK_JOBS_DEFAULT=0
CPPCHECK_JOBS="${CPPCHECK_JOBS:-$CPPCHECK_JOBS_DEFAULT}"

if [ "${CPPCHECK_JOBS}" -le 0 ] 2>/dev/null; then
  if command -v nproc >/dev/null 2>&1; then
    CPPCHECK_JOBS="$(nproc)"
  else
    CPPCHECK_JOBS=4
  fi
fi

echo "Running cppcheck with MISRA addon on ${CC_JSON} using ${CPPCHECK_JOBS} jobs..." >&2

cppcheck \
  -j "${CPPCHECK_JOBS}" \
  --project="${CC_JSON}" \
  --enable=style,warning,performance,portability \
  --inconclusive \
  --force \
  --inline-suppr \
  --addon=/opt/misra/misra.json \
  --error-exitcode=1 \
  --xml --xml-version=2 2> cppcheck_misra_results.xml

echo "MISRA analysis completed. XML saved to ${PROJ_DIR}/cppcheck_misra_results.xml" >&2
EOF

RUN chmod +x /usr/local/bin/run-misra-check.sh

# ------------------------------------------------------------------------
# Script: build-and-check-all.sh
# ------------------------------------------------------------------------
RUN cat <<'EOF' > /usr/local/bin/build-and-check-all.sh
#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="/workspace/code"

echo "Auto-formatting C/H files under ${ROOT_DIR} (excluding build/ and docs/)..." >&2

INDENT_OPTS=(
  -i2        # 2 spaces indentation
  -nut       # spaces, not tabs
  -br        # braces on same line
  -brf       # function braces on same line
  -bli0      # no extra indent for blank lines
  -npcs      # no space after cast
  -npsl      # keep return type and function name on same line
  -bad       # no blank line after declarations
  -bap       # no blank line after procedures
  -bbb       # no blank line before block
)



# Find and indent all .c/.h files under ROOT_DIR, excluding any path that contains /build/ or /docs/
# - Works for directories named exactly "build" or "docs" at any depth.
# - In-place formatting (no backups) and preserve timestamps where possible.
mapfile -t FILES < <(
  find "${ROOT_DIR}" -type f \( -name "*.c" -o -name "*.h" \) \
    -not -path "*/build/*" \
    -not -path "*/docs/*" \
    -not -path "*/.git/*" \
    | sort
)

if [ "${#FILES[@]}" -eq 0 ]; then
  echo "No .c/.h files found under ${ROOT_DIR} (after exclusions)." >&2
else
  echo "Indenting ${#FILES[@]} files..." >&2
  for f in "${FILES[@]}"; do
  indent "${INDENT_OPTS[@]}" -o "${f}" "${f}"
  done
  echo "Indent formatting completed." >&2
fi

echo "Scanning ${ROOT_DIR} for CMake projects..." >&2

# Collect all directory paths containing a CMakeLists.txt
mapfile -t PROJECT_DIRS < <(
  find "${ROOT_DIR}" -mindepth 2 -maxdepth 2 -type f -name "CMakeLists.txt" -printf "%h\n" \
  | sort -u
)

if [ ${#PROJECT_DIRS[@]} -eq 0 ]; then
  echo "No CMake projects found under ${ROOT_DIR}" >&2
  exit 1
fi

for PROJ in "${PROJECT_DIRS[@]}"; do
  echo "----------------------------------------------------------------"
  echo " Processing project: ${PROJ}"
  echo "----------------------------------------------------------------"

  cd "${PROJ}"

  # Clean and regenerate build directory
  rm -rf build
  mkdir -p build
  cd build

  echo "Configuring CMake in ${PROJ}/build..." >&2
  cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..

  echo "Building ${PROJ}..." >&2
  cmake --build .

  # Run tests if available
  if [ -f "CTestTestfile.cmake" ]; then
    echo "Running CTest in ${PROJ}/build..." >&2
    if ! ctest; then
      echo "⚠️ CTest FAILED in ${PROJ} (continuing)" >&2
    fi
  fi

  # Back to project root for MISRA
  cd "${PROJ}"

  echo "Running MISRA/cppcheck for ${PROJ}..." >&2
  if ! run-misra-check.sh "${PROJ}"; then
    echo "⚠️ MISRA analysis FAILED in ${PROJ} (continuing)" >&2
  fi

  echo "Done with ${PROJ}" >&2
  echo
done

echo "All projects under ${ROOT_DIR} processed." >&2
EOF

RUN chmod +x /usr/local/bin/build-and-check-all.sh

# ------------------------------------------------------------------------
# Script: run-clang-format-all.sh
#
# PURPOSE:
#   Formats all C/C++ source files under the fixed workspace folder:
#       /workspace/code
#
# BEHAVIOR:
#   - Ensures /workspace/code/.clang-format exists with the requested style
#   - Runs clang-format in-place recursively on common C/C++ extensions
#
# NOTE:
#   No user input is accepted (no args, no env vars). The target is fixed.
# ------------------------------------------------------------------------
RUN cat <<'EOF' > /usr/local/bin/run-clang-format-all.sh
#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="/workspace/code"

if [[ ! -d "${ROOT_DIR}" ]]; then
  echo "ERROR: Expected directory does not exist: ${ROOT_DIR}" >&2
  exit 1
fi

# Ensure .clang-format exists at the root (applies to all subfolders)
if [[ ! -f "${ROOT_DIR}/.clang-format" ]]; then
  cat <<'YAML' > "${ROOT_DIR}/.clang-format"
BasedOnStyle: LLVM
IndentWidth: 2
UseTab: Never
BreakBeforeBraces: Attach
AllowShortIfStatementsOnASingleLine: true
AllowShortBlocksOnASingleLine: true
AllowShortFunctionsOnASingleLine: All
AllowShortLoopsOnASingleLine: true
ColumnLimit: 200
SpaceBeforeParens: Never
YAML
fi

echo "Running clang-format recursively under ${ROOT_DIR}..." >&2

find "${ROOT_DIR}" -type f \( \
  -name '*.c' -o -name '*.h' -o -name '*.cpp' -o -name '*.hpp' -o \
  -name '*.cc' -o -name '*.hh' -o -name '*.cxx' -o -name '*.hxx' \
\) -print0 | xargs -0 clang-format -i

echo "clang-format completed." >&2
EOF

RUN chmod +x /usr/local/bin/run-clang-format-all.sh

# ------------------------------------------------------------------------
# Normalize line endings on all scripts under /usr/local/bin
# ------------------------------------------------------------------------
RUN find /usr/local/bin -type f -exec sed -i 's/\r$//' {} \;

# Automatically build and MISRA-check all projects under /workspace/code
CMD ["build-and-check-all.sh"]
